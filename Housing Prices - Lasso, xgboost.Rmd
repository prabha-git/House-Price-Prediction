
output: html_document
---

Inspired by this kernel https://www.kaggle.com/erikbruin/house-prices-lasso-xgboost-and-a-detailed-eda

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load_lib, message=FALSE, warning=TRUE}
library(tidyverse)
library(tidyimpute)
library(corrplot)
library(caret)
library(xgboost)
```


Below , i am reading the train / test csv as dataframes in R

```{r load_data, message=FALSE, warning=FALSE}
train=read_csv("datasets/train.csv")
test=read_csv("datasets/test.csv")
```

Getting the dimensions of the dataset , and looks like difference between train and test is "SalePrice" as expected

```{r}
dim(train)
dim(test)
setdiff(colnames(train),colnames(test))
```

Getting rid of IDs from the dataframe , but we need to keep test_ids fro final submission to kaggle
```{r}
test_id=test$Id
test$Id=NULL
train$Id=NULL
```

combining both train and test for cleaning and feature engineering

```{r}
test$SalePrice=NA
all=rbind(train,test)
dim(all)
```

Exploring teh important variables

1. Response Variable - SalePrice

the sale price are right skewed. We need to handle this scenario before modeling.
```{r}
all %>% drop_na(SalePrice) %>% ggplot(aes(x=SalePrice))+geom_histogram(fill="blue",binwidth=10000)
```


```{r}
summary(all$SalePrice)
```


Find the most important numeric predictors

first focus on numeric predictors, there are 37 numeric columns including SalePrice

```{r}
all %>% select_if(is.numeric) %>% dim()
all_numVar=all %>% select_if(is.numeric) 
cor_numVar=cor(all_numVar,use="pairwise.complete.obs")
```


```{r}
cor_sorted=as.matrix(sort(cor_numVar[,'SalePrice'],decreasing = TRUE))
high_corr=names(cor_sorted[cor_sorted>0.5,])
corr_numVar=cor_numVar[high_corr,high_corr]
corrplot.mixed(corr_numVar,tl.pos="lt",tl.col="black")
```


lets explore 'overallqual' variable, there is definitively positive influence on the SalePrice

```{r}
all %>% drop_na(SalePrice) %>% ggplot(aes(x=as.factor(OverallQual),y=SalePrice))+geom_boxplot(col="blue")
```


Next 'GrLvArea' variable, there are two outliers with hign GrLivArea but low SalePrice
```{r}
all %>% drop_na(SalePrice) %>%ggplot(aes(x=GrLivArea,y=SalePrice))+geom_point(col='blue')+geom_smooth(method='lm',se=FALSE,col='black')
```


Handling missing data, label  encoding & factorizing variables
find out the variables containing missing values, we have to fix 34 predictors

```{r}
NA_col=names(which(colSums(is.na(all))>0))
sort(sort(colSums(is.na(all[,NA_col]))),decreasing = TRUE)
cat('There are ',length(NA_col),' columsn with missing values')
```


Imputing missing data

## {.tabset}

### Pool
The PoolQC is the variable with most NAs. 
PoolQC : Pool quality

Ex Excellent
Gd Good
TA Average/Typical
Fa Fair
NA No Pool

It is obvious most houses will not have pools . these values can be converted as ordinal
```{r}
all$PoolQC[is.na(all$PoolQC)]='None'
all$PoolQC=as.integer(recode(all$PoolQC,'None'=0,'po'=1,'Fa'=2,'TA'=3,'Gd'=4,'Ex'=5))
```

There are three instances where PoolQC is missing while PoolArea is greater than zero. Iam going to impoute based on overall quality
```{r}
all %>% filter(PoolArea>0 & PoolQC==0) %>% select(PoolArea,PoolQC,OverallQual)
all[all$PoolArea==368 & all$OverallQual==4,]['PoolQC']=2
all[all$PoolArea==444 & all$OverallQual==6,]['PoolQC']=3
all[all$PoolArea==561 & all$OverallQual==3,]['PoolQC']=2
```



### Miscellaneous Feature
There are 2814 missing values in 'MiscFeature, As these values are nor ordinal i will convert into factors
Gar2 2nd Garage (if not described in garage section)
Othr Other
Shed Shed (over 100 Sf)
TenC Tennis Court
NA None

```{r}
table(all$MiscFeature,exclude = NULL)
all=all %>%  replace_na(list(MiscFeature="None"))
all$MiscFeature=as.factor(all$MiscFeature)
all %>% drop_na(SalePrice) %>% ggplot(aes(x=MiscFeature,y=SalePrice))+geom_bar(stat='summary',fun.y="median",fill='blue')+geom_label(stat="count",aes(label=..count..,y=..count..))
```


### Alley

Convert values to factors as it is not ordinal
```{r}
table(all$Alley,exclude = NULL)
```

Grvl Gravel
Pave Paved
NA no alley access

```{r}
all=all %>% replace_na(list(Alley="None"))
all$Alley=as.factor(all$Alley)
```


### Fence

Fence has 2348 missing values, 

```{r}
table(all$Fence,exclude = NULL)
all=all %>% replace_na(list(Fence="None"))
table(all$Fence,exclude=NULL)
all %>% drop_na(SalePrice) %>% group_by(Fence) %>% summarise(median=median(SalePrice),mean=mean(SalePrice),count=n())
```

at the first look Fence looks like an ordinal value but median value shown no fence house has higher median and mean prices , hence i will convert fence as factor
```{r}
all$Fence=as.factor(all$Fence)
```

### Fireplace varaibale

Fireplace has NAs . Number of fireplace does not have any NAs.looks like NA is for the house with zero fireplaces

```{r}
table(all$FireplaceQu,all$Fireplaces,exclude=NULL)
all=all %>% replace_na(list(FireplaceQu="None"))
all$FireplaceQu=as.integer(recode(all$FireplaceQu,'None'=0,'Po'=1,'Fa'=2,'TA'=3,'Gd'=4,'Ex'=5))
table(all$FireplaceQu)
```

### Lot variables
LotFrontage : 486 NAs.  reasonable is impute meadian value per neighborhood

```{r}
all %>% drop_na(LotFrontage,SalePrice) %>% ggplot(aes(x=as.factor(Neighborhood),y=SalePrice))+geom_bar(stat="summary",fun.y="median",fill="blue") + theme(axis.text.x = element_text(angle=45,hjust=1))

all=all %>% group_by(Neighborhood) %>% mutate(LotFrontage=ifelse(is.na(LotFrontage),median(LotFrontage,na.rm=T),LotFrontage))
```

LotShape :No NAs , values seems ordinal
   Reg  Regular 
   IR1  Slightly irregular
   IR2  Moderately Irregular
   IR3  Irregular

```{r}
all$LotShape=as.integer(recode(all$LotShape,'IR3'=0,'IR2'=1,'IR1'=2,'Reg'=3))
```

LotConfig : No NAs. The value seems ordinal but visualizing it tells that it may not be ordinal. hence making it factor
```{r}
all %>% drop_na(LotFrontage,SalePrice) %>%ggplot(aes(x=as.factor(LotConfig),y=SalePrice))+geom_bar(stat="summary",fun.y="median",fill="blue") +theme(axis.text.x = element_text(angle=45,hjust=1))

all$LotConfig=as.factor(all$LotConfig)

table(all$LotConfig,exclude=NULL)
```

### Garage Variables
There are 7 Garage varaiables ,
```{r}
garage_variables=grep("Garage*",colnames(all),value = TRUE)
colSums(is.na(all[,garage_variables]))
```


For GarageYrBlt i am going to replace with YearBuilt variable

```{r}
all$GarageYrBlt[is.na(all$GarageYrBlt)]=all$YearBuilt[is.na(all$GarageYrBlt)]
```


lets check 157/159 missing values are the same observations . looks missing values are from the same observation

```{r}
length(which(is.na(all$GarageType) & is.na(all$GarageFinish) & is.na(all$GarageQual) & is.na(all$GarageCond)))
```


lets explore the two observations where GarageType has values. Observation 2127 does have seem have garage so lets imoute with common values
```{r}
all[which(!is.na(all$GarageType) & is.na(all$GarageFinish)),garage_variables]
which(!is.na(all$GarageType) & is.na(all$GarageFinish))


all$GarageCond[2127]=names(sort(table(all$GarageCond),decreasing = TRUE)[1])
all$GarageQual[2127]=names(sort(table(all$GarageQual),decreasing = TRUE)[1])
all$GarageFinish[2127]=names(sort(table(all$GarageFinish),decreasing = TRUE)[1])
```


Looks like this house does not have garage, hence making the garage varibale reflect it

```{r}
all[2577,garage_variables]

all[2577,'GarageType']=NA
all[2577,'GarageArea']=0
all[2577,'GarageCars']=0
```

Below 4 varaibale has 158 NA
```{r}
colSums(is.na(all[,garage_variables]))
```

First looking at GarageType , below value does not seems ordinal. replcae NA with 'No Garage' and converting as factor

```{r}
table(all$GarageType,exclude=NULL)
all=all %>% replace_na(list(GarageType="No Garage"))
all$GarageType=as.factor(all$GarageType)
```

Second, GarageFinish looks like ordinal value.

 Fin  Finished
 RFn  Rough Finished  
 Unf  Unfinished
 NA   No Garage
 
 
```{r}
all=all %>% replace_na(list(GarageFinish='None'))
all$GarageFinish=as.integer(recode(all$GarageFinish,'None'=0,'Unf'=1,'RFn'=2,'Fin'=3))
table(all$GarageFinish,exclude = NULL)
```

third , GarageQual

It is another ordinal value
   Ex   Excellent
   Gd   Good
   TA   Typical/Average
   Fa   Fair
   Po   Poor
   NA   No Garage
   
   
```{r}
all=all %>% replace_na(list(GarageQual='None'))
all$GarageQual=as.integer(recode(all$GarageQual,'None'=0,'Po'=1,'Fa'=2,'TA'=3,'Gd'=4,'Ex'=5))
table(all$GarageQual,exclude = NULL)
```


last GarageCondition , another ordinal variable

```{r}
all=all %>% replace_na(list(GarageCond='None'))
all$GarageCond=as.integer(recode(all$GarageCond,'None'=0,'Po'=1,'Fa'=2,'TA'=3,'Gd'=4,'Ex'=5))
table(all$GarageCond,exclude = NULL)
```


### Basement variables

There are 11 basement features , 5 of those have 79 - 82 missing values . and remaining has 1 or 2 missing values.

```{r}
bsmt_features=grep("Bsmt*",colnames(all),value = TRUE)
bsmt_features

colSums(is.na(all[,bsmt_features]))
```

check if how manu missing values are from same observation
```{r}
length(which(is.na(all$BsmtQual) & is.na(all$BsmtCond) & is.na(all$BsmtExposure) & is.na(all$BsmtFinType2)))
```

Find the other NAs, BsmtFinType1 has 79 missing value.


### Masonary Variables

Two variables MasVnrType & MasVnrArea . MasVnrType has 24 missing and MasVnrArea has 23 missing
```{r}
MasV_variables=grep("MasV*",colnames(all),value = TRUE)
colSums(is.na(all[MasV_variables]))
```

check if the missing values from both the observation are same and.... it looks like ther are the same observation

```{r}
sum(is.na(all$MasVnrArea) & is.na(all$MasVnrType))
```

find the observation with 1 extra missing MasvnrArea , Lets replace the missing value with 'BrkFace'
```{r}
all[which(!is.na(all$MasVnrArea) & is.na(all$MasVnrType)),c("MasVnrArea","MasVnrType")]
all %>% group_by(MasVnrType) %>% summarise(median_Area=median(MasVnrArea),cnt=n())
which(!is.na(all$MasVnrArea) & is.na(all$MasVnrType))
all[2611,'MasVnrType']='BrkFace'
```

Replace the NA with 'None' in MasVnrType
```{r}
all=all %>% replace_na(list(MasVnrType='None'))
```


Looks like common brick and None are cheaper than other categories , will make the variable ordinal accordingly

```{r}
all %>% drop_na(SalePrice) %>% group_by(MasVnrType) %>% summarise(median=median(SalePrice),cnt=n()) %>% arrange(median)


all$MasVnrType=as.integer(recode(all$MasVnrType,'BrkCmn'=0,'None'=0,'BrkFace'=1,'Stone'=2))

table(all$MasVnrType,exclude =NULL)
```

Replace NULL with zeros in MasVnrArea column
```{r}
all=all %>% replace_na(list(MasVnrArea=0))
summary(all$MasVnrArea)
```


### MSZoning 

It has 4 NAs . Values are categorical.

   A    Agriculture
   C    Commercial
   FV   Floating Village Residential
   I    Industrial
   RH   Residential High Density
   RL   Residential Low Density
   RP   Residential Low Density Park 
   RM   Residential Medium Density
   
Lets impute with most common value and convert into factor   
```{r}
table(all$MSZoning,exclude = NULL)

all$MSZoning[is.na(all$MSZoning)]=names(sort(table(all$MSZoning),decreasing = TRUE)[1])

table(all$MSZoning,exclude = NULL)

all$MSZoning=as.factor(all$MSZoning)
```

### Kitchen Variables

KitchenQual : Kitchen quality
It has just one missing variable

```{r}
table(all$KitchenQual,exclude = NULL)
```

replace that variable with most common value
```{r}
which(is.na(all$KitchenQual))
all[1556,"KitchenQual"]="TA"
all$KitchenQual=as.integer(recode(all$KitchenQual,'None'=0,'Po'=1,'Fa'=2,'TA'=3,'Gd'=4,'Ex'=5))

table(all$KitchenQual,exclude = NULL)
```

Number of kitchens above grade
No missing values
```{r}
table(all$KitchenAbvGr)
```


### Utilities
All houses has all public utilities except one and 'NoSeWa' is in train . Hence this variable is useless . hence removing this variable .

```{r}
table(all$Utilities,exclude = NULL)

all$Utilities=NULL
```

### Home Functionality
Ordinal values (Salvage is worst and Typical is best)

   Typ  Typical Functionality
   Min1 Minor Deductions 1
   Min2 Minor Deductions 2
   Mod  Moderate Deductions
   Maj1 Major Deductions 1
   Maj2 Major Deductions 2
   Sev  Severely Damaged
   Sal  Salvage only
Replace the null values with mode
```{r}
table(all$Functional,exclude=NULL)
all=all %>% replace_na(list(Functional="Typ"))

all$Functional=as.integer(recode(all$Functional,'Sal'=0,'Sev'=1,'Maj2'=2,'Maj1'=3,'Mod'=4,'Min2'=5,'Min1'=6,'Typ'=7))

```


### Exterior Variable

There are 4 Exterior variable. Exterior1st & Exterior2nd has one missing value each
```{r}
exterior_variable=grep("Exter*",colnames(all),value=T)
exterior_variable
colSums(is.na(all[,exterior_variable]))
```

Exterior1st - Impute with mode and convert as factor
```{r}
table(all$Exterior1st,exclude = NULL)
which(is.na(all$Exterior1st))
all[2152,"Exterior1st"]="VinylSd"

all$Exterior1st=as.factor(all$Exterior1st)
```

Exterior2nd - Impute with mode and convert as factor

```{r}
table(all$Exterior2nd,exclude = NULL)
which(is.na(all$Exterior2nd))
all[2152,"Exterior2nd"]="VinylSd"
```

ExterQual
Nominal values - lets convert to Nominal

```{r}
table(all$ExterQual,exclude = NULL)

all$ExterQual=as.integer(recode(all$ExterQual,'None'=0,'Po'=1,'Fa'=2,'TA'=3,'Gd'=4,'Ex'=5))
```


ExterCond
No Na. can be converted to Ordinal.

```{r}
table(all$ExterCond,exclude = NULL)
all$ExterCond=as.integer(recode(all$ExterCond,'None'=0,'Po'=1,'Fa'=2,'TA'=3,'Gd'=4,'Ex'=5))
```


### Electrical system

It is categorical feature. replace na with most common value and convert to factor
```{r}
table(all$Electrical,exclude = NULL)
which(is.na(all$Electrical))
all[1380,"Electrical"]="SBrkr"
all$Electrical=as.factor(all$Electrical)
```


### SaleType and Condition

SaleType
Values are categorical, replace na with most common value and convert as factor

```{r}
table(all$SaleType,exclude = NULL)
which(is.na(all$SaleType))
all[2490,"SaleType"]="WD"
all$SaleType=as.factor(all$SaleType)
```

Condtion of sale

categorical value

```{r}
table(all$SaleCondition,exclude = NULL)

all$SaleCondition=as.factor(all$SaleCondition)
```







